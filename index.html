<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Score Keeper</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
        }
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="bg-[#E9E4F5]">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        const DEFAULT_PLAYERS = ['Dm', 'Bd', 'Dd', 'Nr'];
        const DATA_KEY = '@scoreKeeperData_web';
        const BACKUP_KEY = '@scoreKeeperBackup_web';
        const REDO_KEY = '@scoreKeeperRedo_web';
        const HISTORY_KEY = '@scoreKeeperHistory_web';
        const PLAYER_KEY = '@scoreKeeperPlayers_web';

        // --- Initial Data Structure ---
        const getInitialData = (players = DEFAULT_PLAYERS) => {
            const data = {};
            players.forEach(player => {
                data[player] = { patokan_normal: 0, patokan_joker: 0, skor: 0 };
            });
            return data;
        };

        // --- Shared Components (Moved outside App to prevent re-renders) ---

        const CustomSwitch = ({ value, onValueChange, disabled }) => (
            <button
                type="button"
                onClick={() => !disabled && onValueChange(!value)}
                className={`relative inline-flex items-center h-6 rounded-full w-11 transition-colors ${
                    value ? 'bg-[#5D3FD3]' : 'bg-gray-300'
                } ${disabled ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer'}`}
                disabled={disabled}
            >
                <span className={`inline-block w-4 h-4 transform bg-white rounded-full transition-transform ${
                    value ? 'translate-x-6' : 'translate-x-1'
                }`} />
            </button>
        );

        const Modal = ({ isVisible, onClose, title, children }) => {
            if (!isVisible) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4" onClick={onClose}>
                    <div className="bg-white rounded-2xl p-6 shadow-xl max-h-[80vh] w-full max-w-md flex flex-col" onClick={e => e.stopPropagation()}>
                        <h2 className="text-2xl font-bold mb-4 text-center">{title}</h2>
                        <div className="overflow-y-auto flex-grow">{children}</div>
                        <button onClick={onClose} className="w-full bg-[#5D3FD3] text-white font-bold py-3 px-4 rounded-lg mt-4 hover:bg-[#4B0082] transition-colors">Tutup</button>
                    </div>
                </div>
            );
        };

        const ConfirmationModal = ({ isOpen, title, message, onConfirm, onClose }) => {
            if (!isOpen) return null;
            const handleConfirm = () => {
                onClose(); // Close UI immediately
                onConfirm(); // Then execute logic
            };
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
                    <div className="bg-white rounded-2xl p-6 shadow-xl w-full max-w-sm" onClick={e => e.stopPropagation()}>
                        <h2 className="text-xl font-bold mb-2 text-center">{title}</h2>
                        <p className="text-gray-600 mb-6 text-center">{message}</p>
                        <div className="flex justify-center gap-4">
                            <button onClick={onClose} className="flex-1 bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">Batal</button>
                            <button onClick={handleConfirm} className="flex-1 bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700">YA</button>
                        </div>
                    </div>
                </div>
            );
        };

        const ScoreTable = ({ data, players }) => {
            if (!data) return <div className="text-center mt-5 text-lg text-gray-600">Loading data...</div>;
            return (
                <div className="bg-white rounded-xl p-4 mb-5 shadow-md">
                    <div className="flex pb-2 border-b-2 border-gray-300">
                        <p className="flex-[3] text-base font-bold text-black">Pemain</p>
                        <p className="flex-1 text-base font-bold text-black text-center">N</p>
                        <p className="flex-1 text-base font-bold text-black text-center">J</p>
                        <p className="flex-[2] text-base font-bold text-black text-right">Skor</p>
                    </div>
                    {players.map(player => {
                        const info = data[player];
                        const score = info?.skor ?? 0;
                        const scoreColor = score > 0 ? 'text-green-600' : score < 0 ? 'text-red-600' : 'text-gray-800';
                        return(
                            <div key={player} className="flex items-center py-2.5 border-b border-gray-100 last:border-b-0">
                                <p className="flex-[3] text-base text-gray-800">{player}</p>
                                <p className="flex-1 text-base text-gray-800 text-center">{info?.patokan_normal ?? 0}</p>
                                <p className="flex-1 text-base text-gray-800 text-center">{info?.patokan_joker ?? 0}</p>
                                <p className={`flex-[2] text-base text-right font-bold ${scoreColor}`}>
                                    {score.toFixed(2).replace('.', ',')}
                                </p>
                            </div>
                        );
                    })}
                </div>
            );
        };

        const WinSection = ({ players, onUpdateScore, onUpdateTeamScore, setNotification }) => {
            const [winners, setWinners] = useState([]);
            const [isJoker, setIsJoker] = useState(false);
            const [isWin2, setIsWin2] = useState(false);
            const [jokerHolders, setJokerHolders] = useState([]);
            const [buyers, setBuyers] = useState({});

            // Reset local state when players change
            useEffect(() => {
                setBuyers(players.reduce((acc, p) => ({...acc, [p]: ''}), {}));
                setWinners([]); setIsJoker(false); setIsWin2(false); setJokerHolders([]);
            }, [players]);

            const togglePlayer = (p, list, setList) => {
                setList(prev => prev.includes(p) ? prev.filter(i => i !== p) : [...prev, p]);
            };
            const resetForm = () => {
                setWinners([]); setIsJoker(false); setIsWin2(false); setJokerHolders([]);
                setBuyers(players.reduce((acc, p) => ({...acc, [p]: ''}), {}));
            };
            const handleSubmit = () => {
                if (winners.length === 0 || winners.length > 2) {
                    setNotification({message: 'Pilih 1 atau 2 pemenang.', type: 'error'}); return;
                }
                const parsedBuyers = Object.entries(buyers)
                    .filter(([,amount]) => amount && !isNaN(parseInt(amount)))
                    .map(([name, amount]) => ({name, amount: parseInt(amount)}));
                
                if (winners.length === 1) {
                    onUpdateScore(winners[0], isJoker, isWin2, jokerHolders, parsedBuyers);
                } else {
                    onUpdateTeamScore(winners, jokerHolders, parsedBuyers);
                }
                resetForm();
            };
            const possibleLosers = players.filter(p => !winners.includes(p));

            return (
                <div className="bg-white rounded-xl p-4 mb-5 shadow-md">
                    <h2 className="text-xl font-bold mb-4 text-[#4B0082]">üèÜ Catat Kemenangan</h2>
                    <label className="text-base font-semibold mb-2 block text-gray-700">1. Pilih Pemenang (1 atau 2)</label>
                    <div className="flex flex-wrap mb-3 -m-1">
                        {players.map(p => (
                            <button key={p} onClick={() => togglePlayer(p, winners, setWinners)} className={`py-2 px-4 rounded-full m-1 border transition-colors ${winners.includes(p) ? 'bg-[#5D3FD3] border-[#4B0082] text-white' : 'bg-gray-100 border-gray-300 text-gray-800'}`}>
                                {p}
                            </button>
                        ))}
                    </div>
                    <div className="flex justify-between items-center py-2">
                        <label className="text-base font-semibold text-gray-700">Menang Joker?</label>
                        <CustomSwitch value={isJoker} onValueChange={setIsJoker} disabled={winners.length === 2}/>
                    </div>
                    <div className="flex justify-between items-center py-2">
                        <label className="text-base font-semibold text-gray-700">Menang x2?</label>
                        <CustomSwitch value={isWin2} onValueChange={setIsWin2} disabled={winners.length === 2}/>
                    </div>
                    <label className="text-base font-semibold mt-4 mb-2 block text-gray-700">2. Opsi Tambahan (Opsional)</label>
                    <p className="text-sm font-medium mb-1 text-gray-600">Penalti Joker (yang kalah)</p>
                    <div className="flex flex-wrap mb-3 -m-1">
                        {possibleLosers.map(p => (
                            <button key={p} onClick={() => togglePlayer(p, jokerHolders, setJokerHolders)} className={`py-2 px-4 rounded-full m-1 border transition-colors ${jokerHolders.includes(p) ? 'bg-[#5D3FD3] border-[#4B0082] text-white' : 'bg-gray-100 border-gray-300 text-gray-800'}`}>
                                {p} -j
                            </button>
                        ))}
                    </div>
                    <p className="text-sm font-medium mb-2 text-gray-600">Buy Poin</p>
                    <div className="grid grid-cols-2 gap-x-4 gap-y-2">
                        {players.map(p => (
                            <div key={p} className="flex items-center">
                                <label className="flex-1 text-base">{p} buy:</label>
                                <input type="number" placeholder="0" value={buyers[p] || ''} onChange={e => setBuyers(prev => ({...prev, [p]: e.target.value}))} className="flex-1 border border-gray-300 rounded-lg p-2 text-center w-full"/>
                            </div>
                        ))}
                    </div>
                    <button onClick={handleSubmit} className="w-full bg-[#5D3FD3] text-white font-bold py-3 px-4 rounded-lg mt-4 hover:bg-[#4B0082] transition-colors">Submit Kemenangan</button>
                </div>
            );
        };

        const JokerTransferSection = ({ players, onJokerTransfer }) => {
            const [gainer, setGainer] = useState(null);
            const [loser, setLoser] = useState(null);
            useEffect(() => {setGainer(null);setLoser(null);}, [players]);
            return (
                <div className="bg-white rounded-xl p-4 mb-5 shadow-md">
                    <h2 className="text-xl font-bold mb-4 text-[#4B0082]">üÉè Transfer Joker</h2>
                    <label className="text-base font-semibold mb-2 block text-gray-700">Penerima (dapat poin)</label>
                    <div className="flex flex-wrap mb-3 -m-1">
                        {players.map(p => ( <button key={p} onClick={() => setGainer(p)} className={`py-2 px-4 rounded-full m-1 border transition-colors ${gainer === p ? 'bg-[#5D3FD3] border-[#4B0082] text-white' : 'bg-gray-100 border-gray-300 text-gray-800'}`}>{p}</button>))}
                    </div>
                    <label className="text-base font-semibold mb-2 block text-gray-700">Pemberi (kena penalti)</label>
                    <div className="flex flex-wrap mb-3 -m-1">
                        {players.map(p => ( <button key={p} onClick={() => setLoser(p)} className={`py-2 px-4 rounded-full m-1 border transition-colors ${loser === p ? 'bg-[#5D3FD3] border-[#4B0082] text-white' : 'bg-gray-100 border-gray-300 text-gray-800'}`}>{p}</button>))}
                    </div>
                    <button onClick={() => onJokerTransfer(gainer, loser)} className="w-full bg-[#5D3FD3] text-white font-bold py-3 px-4 rounded-lg mt-4 hover:bg-[#4B0082] transition-colors">Transfer</button>
                </div>
            );
        };

        const ActionsSection = ({ onUndo, onRedo, onResetScores, onResetStakes }) => (
            <div className="bg-white rounded-xl p-4 shadow-md">
                <h2 className="text-xl font-bold mb-4 text-[#4B0082]">‚ö°Ô∏è Tindakan Cepat</h2>
                <div className="grid grid-cols-2 gap-3">
                    <button onClick={onUndo} className="bg-gray-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-700 transition-colors">‚Ü©Ô∏è Undo</button>
                    <button onClick={onRedo} className="bg-gray-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-700 transition-colors">‚Ü™Ô∏è Redo</button>
                    <button onClick={onResetScores} className="bg-red-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-700 transition-colors">Reset Skor</button>
                    <button onClick={onResetStakes} className="bg-red-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-700 transition-colors">Reset Poin</button>
                </div>
            </div>
        );

        const EditScoresModal = ({ isVisible, onClose, data, players, onSave }) => {
            const [editScores, setEditScores] = useState({});

            useEffect(() => {
                if (data && isVisible) {
                    const obj = {};
                    players.forEach(p => {
                        // Format score to 2 decimal places for consistency
                        obj[p] = data[p].skor.toFixed(2); 
                    });
                    setEditScores(obj);
                }
            }, [data, isVisible, players]);

            const handleSave = () => {
                onSave(editScores);
            };

            if (!isVisible) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4" onClick={onClose}>
                    <div className="bg-white rounded-2xl p-6 shadow-xl max-h-[80vh] w-full max-w-md flex flex-col" onClick={e => e.stopPropagation()}>
                        <h2 className="text-2xl font-bold mb-4 text-center">‚úèÔ∏è Edit Skor Manual (0.5)</h2>
                        <div className="overflow-y-auto flex-grow">
                            {players.map(p => (
                                <div key={p} className="flex items-center mb-4">
                                    <label className="flex-1 text-base font-bold">{p}</label>
                                    {/* Updated step to 0.5 */}
                                    <input type="number" step="0.5" value={editScores[p] || ''} onChange={e => setEditScores(s => ({...s, [p]: e.target.value}))} className="flex-1 border border-gray-300 rounded-lg p-2 text-center w-full"/>
                                </div>
                            ))}
                        </div>
                        <button onClick={handleSave} className="w-full bg-[#5D3FD3] text-white font-bold py-3 px-4 rounded-lg mt-4 hover:bg-[#4B0082] transition-colors">Simpan</button>
                        <button onClick={onClose} className="w-full bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg mt-2 hover:bg-gray-400">Batal</button>
                    </div>
                </div>
            );
        };

        const EditPlayersModal = ({ isVisible, onClose, players, onSave }) => {
            const [editPlayers, setEditPlayers] = useState([]);
            const [numPlayers, setNumPlayers] = useState(2);

            useEffect(() => {
                if(isVisible) {
                    setEditPlayers([...players]);
                    setNumPlayers(players.length);
                }
            }, [isVisible, players]);

            const handleNumPlayersChange = (e) => {
                let val = Math.max(2, Math.min(8, parseInt(e.target.value) || 2));
                setNumPlayers(val);
                let newPlayers = [...editPlayers];
                if (val > newPlayers.length) {
                    for (let i = newPlayers.length; i < val; i++) {
                        newPlayers.push(`Player${i+1}`);
                    }
                } else {
                    newPlayers = newPlayers.slice(0, val);
                }
                setEditPlayers(newPlayers);
            };

            const handleSavePlayers = () => {
                onSave(editPlayers);
                onClose();
            };

            if (!isVisible) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4" onClick={onClose}>
                    <div className="bg-white rounded-2xl p-6 shadow-xl max-h-[90vh] w-full max-w-md flex flex-col" onClick={e => e.stopPropagation()}>
                        <h2 className="text-2xl font-bold mb-4 text-center">üë• Edit Pemain</h2>
                        <div className="mb-4">
                            <label className="block font-semibold mb-2">Jumlah Pemain (2-8):</label>
                            <input type="number" min={2} max={8} value={numPlayers} onChange={handleNumPlayersChange} className="border border-gray-300 rounded-lg p-2 text-center w-full font-bold"/>
                        </div>
                        <div className="overflow-y-auto flex-grow">
                            {Array.from({length: numPlayers}).map((_, idx) => (
                                <div key={idx} className="flex items-center mb-3">
                                    <label className="w-12 text-base font-bold text-gray-700">{idx+1}.</label>
                                    <input type="text" value={editPlayers[idx] || ""} onChange={e => {
                                        const arr = [...editPlayers];
                                        arr[idx] = e.target.value;
                                        setEditPlayers(arr);
                                    }} className="flex-1 border border-gray-300 rounded-lg p-2 text-center w-full"/>
                                </div>
                            ))}
                        </div>
                        <button onClick={handleSavePlayers} className="w-full bg-[#5D3FD3] text-white font-bold py-3 px-4 rounded-lg mt-4 hover:bg-[#4B0082] transition-colors">Simpan</button>
                        <button onClick={onClose} className="w-full bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg mt-2 hover:bg-gray-400">Batal</button>
                    </div>
                </div>
            );
        };

        const EditStakesModal = ({ isVisible, onClose, data, players, onSave }) => {
            const [stakes, setStakes] = useState({});

            useEffect(() => {
                if (data && isVisible) {
                    const obj = {};
                    players.forEach(p => {
                        // Format stakes without decimals for integer input
                        obj[p] = {
                            n: Math.round(data[p].patokan_normal).toString(),
                            j: Math.round(data[p].patokan_joker).toString()
                        };
                    });
                    setStakes(obj);
                }
            }, [data, isVisible, players]);

            const handleSaveStakes = () => {
                onSave(stakes);
                onClose();
            };

            if (!isVisible) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4" onClick={onClose}>
                    <div className="bg-white rounded-2xl p-6 shadow-xl max-h-[80vh] w-full max-w-md flex flex-col" onClick={e => e.stopPropagation()}>
                        <h2 className="text-2xl font-bold mb-4 text-center">‚öôÔ∏è Edit Patokan Poin (Bilangan Bulat)</h2>
                        <div className="overflow-y-auto flex-grow">
                            {players.map(p => (
                                <div key={p} className="flex items-center mb-4">
                                    <label className="flex-1 text-base font-bold">{p}</label>
                                    {/* Updated step to 1 for integer input */}
                                    <input type="number" step="1" value={stakes[p]?.n || ''} onChange={e => setStakes(s => ({...s, [p]: {...s[p], n: e.target.value}}))} className="flex-1 border border-gray-300 rounded-lg p-2 text-center w-full" placeholder="Normal" />
                                    <input type="number" step="1" value={stakes[p]?.j || ''} onChange={e => setStakes(s => ({...s, [p]: {...s[p], j: e.target.value}}))} className="flex-1 border border-gray-300 rounded-lg p-2 text-center w-full ml-2" placeholder="Joker" />
                                </div>
                            ))}
                        </div>
                        <button onClick={handleSaveStakes} className="w-full bg-gray-600 text-white font-bold py-3 px-4 rounded-lg mt-4 hover:bg-gray-700 transition-colors">Simpan Patokan</button>
                        <button onClick={onClose} className="w-full bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg mt-2 hover:bg-gray-400">Batal</button>
                    </div>
                </div>
            );
        };

        const DebugModal = ({ isVisible, onClose, info }) => {
            if (!isVisible) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4" onClick={onClose}>
                    <div className="bg-white rounded-2xl p-6 shadow-xl max-h-[80vh] w-full max-w-md flex flex-col" onClick={e => e.stopPropagation()}>
                        <h2 className="text-2xl font-bold mb-4 text-center">üêû Debug Perhitungan Terakhir</h2>
                        <div className="overflow-y-auto flex-grow text-left text-sm" dangerouslySetInnerHTML={{__html: info}} />
                        <button onClick={onClose} className="w-full bg-[#5D3FD3] text-white font-bold py-3 px-4 rounded-lg mt-4 hover:bg-[#4B0082] transition-colors">Tutup</button>
                    </div>
                </div>
            );
        };

        // --- Main App Component ---

        const App = () => {
            const [players, setPlayers] = useState(DEFAULT_PLAYERS);
            const [data, setData] = useState(null);
            const [notification, setNotificationRaw] = useState({ message: 'Welcome! Use the Help menu to start.', type: 'info' });
            
            // UI States
            const [helpModalVisible, setHelpModalVisible] = useState(false);
            const [editModalVisible, setEditModalVisible] = useState(false);
            const [editPlayersModalVisible, setEditPlayersModalVisible] = useState(false);
            const [editStakesModalVisible, setEditStakesModalVisible] = useState(false);
            const [debugModalVisible, setDebugModalVisible] = useState(false);
            const [debugInfo, setDebugInfo] = useState(null);
            const [confirmModal, setConfirmModal] = useState({ isOpen: false, title: '', message: '', onConfirm: () => {} });

            // MODIFIED: Auto-scroll to top when notification appears
            const setNotification = useCallback((notif) => {
                setNotificationRaw(notif);
                if (notif && notif.message) {
                    window.scrollTo(0, 0); // Directly scroll to top instantly
                    setTimeout(() => {
                        setNotificationRaw({ message: '', type: notif.type || 'info' });
                    }, 2000);
                }
            }, []);

            // --- Load players on initial render ---
            useEffect(() => {
                try {
                    const jsonPlayers = localStorage.getItem(PLAYER_KEY);
                    if (jsonPlayers) {
                        setPlayers(JSON.parse(jsonPlayers));
                    }
                } catch (e) {}
            }, []);

            // --- Load data on initial render ---
            useEffect(() => {
                try {
                    const jsonPlayers = localStorage.getItem(PLAYER_KEY);
                    const loadedPlayers = jsonPlayers ? JSON.parse(jsonPlayers) : DEFAULT_PLAYERS;
                    setPlayers(loadedPlayers);
                    const jsonData = localStorage.getItem(DATA_KEY);
                    setData(jsonData ? JSON.parse(jsonData) : getInitialData(loadedPlayers));
                } catch (e) {
                    setPlayers(DEFAULT_PLAYERS);
                    setData(getInitialData(DEFAULT_PLAYERS));
                }
            }, []);

            // --- Data Persistence ---
            const saveData = useCallback((newData, backupCurrent = true) => {
                try {
                    if (backupCurrent && data) {
                        localStorage.setItem(BACKUP_KEY, JSON.stringify(data));
                        localStorage.removeItem(REDO_KEY);
                    }
                    localStorage.setItem(DATA_KEY, JSON.stringify(newData));
                    setData(newData);
                } catch (e) {
                    setNotification({ message: 'Error saving data!', type: 'error' });
                }
            }, [data, setNotification]);

            const logHistory = useCallback((text) => {
                const time = new Date().toLocaleString('id-ID', { hour12: false });
                const newEntry = `[${time}] ${text}`;
                const currentHistory = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
                const updatedHistory = [newEntry, ...currentHistory].slice(50); // Keep last 50
                localStorage.setItem(HISTORY_KEY, JSON.stringify(updatedHistory));
            }, []);

            // --- Core Logic Handlers ---
            const handleUpdateScore = (winner, isJoker, isWin2, jokerHolders = [], buyers = []) => {
                if (!data) return;
                const newData = JSON.parse(JSON.stringify(data));
                const winnerCap = winner;

                const key = isJoker ? 'patokan_joker' : 'patokan_normal';
                for (const p of players) {
                    if (newData[p][key] <= 0) {
                        setNotification({message: `‚ö†Ô∏è Gagal! ${p} belum set nilai ${isJoker ? 'Joker' : 'Normal'}.`, type: 'error'});
                        return;
                    }
                }

                const losers = players.filter(p => p !== winnerCap);
                let totalLoss = 0;

                losers.forEach(loser => {
                    const normalStake = newData[loser].patokan_normal;
                    const jokerStake = newData[loser].patokan_joker;
                    let baseLoss = newData[loser][key];
                    let jokerPenaltyCalc = jokerHolders.includes(loser) ? (jokerStake - normalStake) : 0;
                    const buyerInfo = buyers.find(b => b.name === loser);
                    let buyPenaltyCalc = buyerInfo ? buyerInfo.amount * normalStake : 0;
                    let loss = baseLoss + jokerPenaltyCalc + buyPenaltyCalc;
                    if (isWin2) loss *= 2;
                    newData[loser].skor -= loss;
                    totalLoss += loss;
                });

                newData[winnerCap].skor += totalLoss;

                const totalCheck = players.reduce((sum, p) => sum + newData[p].skor, 0);
                if (Math.abs(totalCheck) > 0.01) {
                    setNotification({ message: `‚ùå Perubahan dibatalkan! Total skor tidak seimbang (${totalCheck.toFixed(2)}).`, type: 'error' });
                    return;
                }

                saveData(newData);
                let logMsg = `${winnerCap} menang ronde ${isJoker ? 'joker' : 'biasa'}${isWin2 ? ' (x2)' : ''} (+${totalLoss.toFixed(2)})`;
                if (jokerHolders.length > 0) logMsg += `, penalti joker: ${jokerHolders.join(', ')}`;
                if (buyers.length > 0) logMsg += `, buy: ${buyers.map(b => `${b.name} ${b.amount}x`).join(', ')}`;
                logHistory(logMsg);
                setNotification({ message: `üéâ ${logMsg}`, type: 'success' });
            };

            const handleUpdateTeamScore = (winners, jokerHolders = [], buyers = []) => {
                if (!data) return;
                let newData = JSON.parse(JSON.stringify(data));
                for (const p of players) {
                    if (newData[p].patokan_normal <= 0) {
                        setNotification({ message: `‚ö†Ô∏è Gagal! ${p} belum set nilai Normal.`, type: 'error' });
                        return;
                    }
                }
                const losers = players.filter(p => !winners.includes(p));
                const winnerBuyers = buyers.filter(b => winners.includes(b.name));
                const loserBuyers = buyers.filter(b => losers.includes(b.name));
                if (winnerBuyers.length > 1) {
                    setNotification({ message: `‚ùå Hanya satu pemenang yang boleh buy.`, type: 'error' });
                    return;
                }
                const totalNormalStake = players.reduce((sum, p) => sum + newData[p].patokan_normal, 0);
                const baseChange = totalNormalStake / players.length;
                let totalJokerPenalty = 0;
                jokerHolders.forEach(jh => { totalJokerPenalty += newData[jh].patokan_joker - newData[jh].patokan_normal; });
                let totalLoserBuyPenalty = 0;
                loserBuyers.forEach(b => { totalLoserBuyPenalty += b.amount * newData[b.name].patokan_normal; });
                losers.forEach(loser => {
                    let currentLoss = baseChange;
                    const jokerPenaltyCalc = jokerHolders.includes(loser) ? (newData[loser].patokan_joker - newData[loser].patokan_normal) : 0;
                    const buyerInfo = loserBuyers.find(b => b.name === loser);
                    const buyPenaltyCalc = buyerInfo ? buyerInfo.amount * newData[loser].patokan_normal : 0;
                    currentLoss += jokerPenaltyCalc + buyPenaltyCalc;
                    newData[loser].skor -= currentLoss;
                });
                const totalGainFromLosers = totalJokerPenalty + totalLoserBuyPenalty;
                const baseGainPerWinner = baseChange + (totalGainFromLosers / winners.length);
                if (winnerBuyers.length === 1 && winners.length === 2) {
                    const winnerBuyer = winnerBuyers[0];
                    const otherWinner = winners.find(w => w !== winnerBuyer.name);
                    const transferAmount = (newData[winnerBuyer.name].patokan_normal * winnerBuyer.amount) / winners.length;
                    newData[winnerBuyer.name].skor += baseGainPerWinner - transferAmount;
                    newData[otherWinner].skor += baseGainPerWinner + transferAmount;
                } else {
                    winners.forEach(winner => { newData[winner].skor += baseGainPerWinner; });
                }
                const totalCheck = players.reduce((sum, p) => sum + newData[p].skor, 0);
                if (Math.abs(totalCheck) > 0.01) {
                    setNotification({ message: `‚ùå Perubahan dibatalkan! Total skor tidak seimbang (${totalCheck.toFixed(2)}).`, type: 'error' });
                    return;
                }
                saveData(newData);
                let logMsg = `Tim ${winners.join(' & ')} menang`;
                if (jokerHolders.length > 0) logMsg += `, penalti joker: ${jokerHolders.join(', ')}`;
                if (buyers.length > 0) logMsg += `, buy: ${buyers.map(b => `${b.name} ${b.amount}x`).join(', ')}`;
                logHistory(logMsg);
                setNotification({ message: `ü§ù ${logMsg}`, type: 'success' });
            };

            const handleJokerTransfer = (gainer, loser) => {
                if (!data) return;
                if (!gainer || !loser || gainer === loser) {
                    setNotification({message: "Pilih 2 pemain yang berbeda.", type: 'error'});
                    return;
                }
                const newData = JSON.parse(JSON.stringify(data));
                if (newData[loser].patokan_joker <= 0 || newData[loser].patokan_normal <= 0) {
                    setNotification({ message: `‚ö†Ô∏è Gagal! ${loser} belum set patokan.`, type: 'error'});
                    return;
                }
                const transferAmount = newData[loser].patokan_joker - newData[loser].patokan_normal;
                newData[gainer].skor += transferAmount;
                newData[loser].skor -= transferAmount;
                saveData(newData);
                const logMsg = `Transfer joker dari ${loser} ke ${gainer} (${transferAmount.toFixed(2)} poin)`;
                logHistory(logMsg);
                setNotification({ message: `üÉè ${logMsg}`, type: 'success' });
            };

            const handleResetScores = () => {
                setConfirmModal({
                    isOpen: true,
                    title: "Reset Skor?",
                    message: "Apakah Anda yakin ingin mereset semua skor pemain ke 0?",
                    onConfirm: () => {
                        if (!data) return;
                        const newData = JSON.parse(JSON.stringify(data));
                        players.forEach(p => (newData[p].skor = 0));
                        saveData(newData);
                        logHistory("Semua skor direset ke 0.");
                        setNotification({ message: "üîÑ Semua skor berhasil direset ke 0.", type: 'success' });
                    }
                });
            };

            const handleResetStakes = () => {
                setConfirmModal({
                    isOpen: true,
                    title: "Reset Poin?",
                    message: "Apakah Anda yakin ingin mereset semua patokan poin (N & J) ke 0?",
                    onConfirm: () => {
                        if (!data) return;
                        const newData = JSON.parse(JSON.stringify(data));
                        players.forEach(p => {
                            newData[p].patokan_normal = 0;
                            newData[p].patokan_joker = 0;
                        });
                        saveData(newData);
                        logHistory("Semua patokan poin direset ke 0.");
                        setNotification({ message: "üßÆ Semua patokan poin berhasil direset.", type: 'success' });
                    }
                });
            };

            const handleUndo = () => {
                const backupJson = localStorage.getItem(BACKUP_KEY);
                if (!backupJson) {
                    setNotification({ message: "‚ùå Tidak ada backup untuk di-undo.", type: 'error' });
                    return;
                }
                localStorage.setItem(REDO_KEY, JSON.stringify(data));
                const backupData = JSON.parse(backupJson);
                setData(backupData);
                localStorage.setItem(DATA_KEY, JSON.stringify(backupData));
                logHistory("Perubahan terakhir dibatalkan (undo).");
                setNotification({ message: "‚Ü©Ô∏è Undo berhasil!", type: 'success' });
            };

            const handleRedo = () => {
                const redoJson = localStorage.getItem(REDO_KEY);
                if (!redoJson) {
                    setNotification({ message: "‚ùå Tidak ada perubahan untuk di-redo.", type: 'error' });
                    return;
                }
                localStorage.setItem(BACKUP_KEY, JSON.stringify(data));
                const redoData = JSON.parse(redoJson);
                setData(redoData);
                localStorage.setItem(DATA_KEY, JSON.stringify(redoData));
                localStorage.removeItem(REDO_KEY);
                logHistory("Perubahan terakhir diulang (redo).");
                setNotification({ message: "‚û°Ô∏è Redo berhasil!", type: 'success' });
            };

            const handleShowDebug = () => {
                let detail = "";
                try {
                    const prevData = JSON.parse(localStorage.getItem(BACKUP_KEY) || "{}");
                    const currData = JSON.parse(localStorage.getItem(DATA_KEY) || "{}");
                    detail += `<div class='font-bold mb-2'>Detail perubahan skor round terakhir:</div>`;
                    players.forEach(p => {
                        const prev = prevData[p]?.skor ?? 0;
                        const curr = currData[p]?.skor ?? 0;
                        const diff = (curr - prev).toFixed(2);
                        detail += `<div>${p}: <span style='color:${diff>0?'green':diff<0?'red':'#444'}'>${prev.toFixed(2)} ‚ûî ${curr.toFixed(2)} (${diff>0?'+':''}${diff})</span></div>`;
                    });
                } catch (e) {
                    detail = "Gagal parsing data debug.";
                }
                setDebugInfo(detail);
                setDebugModalVisible(true);
            };

            // Modal save handlers
            const handleSaveScores = (editScores) => {
                const newData = JSON.parse(JSON.stringify(data));
                let totalCheck = 0;

                // Validate Total Sum first
                players.forEach(p => {
                    // Use Math.round to handle potential floating point issues when parsing 0.5 steps
                    const val = parseFloat(editScores[p]) || 0;
                    totalCheck += val;
                });

                if (Math.abs(totalCheck) > 0.01) {
                    setNotification({ message: `‚ùå Gagal! Total skor tidak seimbang (${totalCheck.toFixed(2)}). Total harus 0.`, type: 'error' });
                    return;
                }

                // If valid, save
                players.forEach(p => {
                    newData[p].skor = parseFloat(editScores[p]) || 0;
                });
                saveData(newData);
                logHistory("Edit manual skor pemain.");
                setNotification({message: "‚úèÔ∏è Skor berhasil diedit.", type: "success"});
                setEditModalVisible(false);
            };

            const handleSavePlayers = (editPlayers) => {
                let validPlayers = editPlayers.map(p => p.trim()).filter(p => p.length > 0);
                if (validPlayers.length < 2) {
                    setNotification({message:"Minimal 2 pemain!", type:"error"});
                    return;
                }
                localStorage.setItem(PLAYER_KEY, JSON.stringify(validPlayers));
                setPlayers(validPlayers);
                let newData = getInitialData(validPlayers);
                validPlayers.forEach(p => {
                    if (data && data[p]) newData[p] = {...data[p]};
                });
                saveData(newData, false);
                logHistory(`Edit pemain: ${validPlayers.join(', ')}`);
                setNotification({message: "‚úÖ Nama & jumlah pemain berhasil diupdate!", type: "success"});
            };

            const handleSaveStakes = (stakes) => {
                const newData = JSON.parse(JSON.stringify(data));
                players.forEach(p => {
                    // Use Math.round to ensure integer values are saved even if input was float
                    newData[p].patokan_normal = Math.round(parseFloat(stakes[p].n) || 0);
                    newData[p].patokan_joker = Math.round(parseFloat(stakes[p].j) || 0);
                });
                saveData(newData);
                setNotification({message: '‚úÖ Nilai patokan berhasil diupdate!', type: 'success'});
            };

            const notificationColors = {
                info: 'bg-blue-100 text-blue-800',
                success: 'bg-green-100 text-green-800',
                error: 'bg-red-100 text-red-800'
            };

            return (
                <div className="max-w-2xl mx-auto">
                    <Modal isVisible={helpModalVisible} onClose={() => setHelpModalVisible(false)} title="üìò Panduan Bot Skor">
                         <div className="text-left text-base leading-relaxed text-gray-700 space-y-4">
                            <div>
                                <h3 className="font-bold text-lg text-[#4B0082]">Set Patokan Poin</h3>
                                <p>Isi nilai Normal (N) dan Joker (J) untuk tiap pemain, lalu tekan 'Simpan Poin'. Patokan ini digunakan untuk menghitung skor saat ada yang menang.</p>
                            </div>
                            <div>
                                <h3 className="font-bold text-lg text-[#4B0082]">Catat Kemenangan</h3>
                                <p>1. <span className="font-bold">Pilih Pemenang:</span> Tekan nama pemain yang menang. Pilih 1 untuk menang sendiri, atau 2 untuk menang tim.</p>
                                <p>2. <span className="font-bold">Opsi Menang (Sendiri):</span> Aktifkan 'Menang Joker' atau 'Menang x2' jika perlu.</p>
                                <p>3. <span className="font-bold">Opsi Tambahan:</span> Pilih pemain yang kalah dan terkena penalti joker, atau isi jumlah 'buy' untuk pemain yang melakukan buy.</p>
                                <p>4. Tekan <span className="font-bold">'Submit Kemenangan'</span> untuk menghitung skor.</p>
                            </div>
                            <div>
                                <h3 className="font-bold text-lg text-[#4B0082]">Transfer Joker</h3>
                                <p>Gunakan ini jika ada transfer poin joker di luar ronde kemenangan. Pilih penerima poin dan pemberi penalti, lalu tekan 'Transfer'.</p>
                            </div>
                            <div>
                                <h3 className="font-bold text-lg text-[#4B0082]">Tindakan Cepat</h3>
                                <p>- <span className="font-bold">Undo:</span> Membatalkan aksi terakhir.</p>
                                <p>- <span className="font-bold">Redo:</span> Mengembalikan aksi yang di-undo.</p>
                                <p>- <span className="font-bold">Reset Skor:</span> Mengembalikan skor semua pemain ke 0.</p>
                                <p>- <span className="font-bold">Reset Poin:</span> Mengembalikan patokan N dan J ke 0.</p>
                            </div>
                         </div>
                    </Modal>

                    <DebugModal isVisible={debugModalVisible} onClose={() => setDebugModalVisible(false)} info={debugInfo} />
                    
                    <EditScoresModal 
                        isVisible={editModalVisible} 
                        onClose={() => setEditModalVisible(false)}
                        data={data}
                        players={players}
                        onSave={handleSaveScores}
                    />

                    <EditPlayersModal 
                        isVisible={editPlayersModalVisible}
                        onClose={() => setEditPlayersModalVisible(false)}
                        players={players}
                        onSave={handleSavePlayers}
                    />
                    
                    <ConfirmationModal 
                        isOpen={confirmModal.isOpen}
                        title={confirmModal.title}
                        message={confirmModal.message}
                        onConfirm={confirmModal.onConfirm}
                        onClose={() => setConfirmModal({ ...confirmModal, isOpen: false })}
                    />

                    <div className="p-4 pb-24">
                        <div className="flex justify-end gap-2 mb-2">
                            <button onClick={() => setHelpModalVisible(true)} className="w-8 h-8 rounded-full bg-white flex items-center justify-center text-[#4B0082] text-lg font-bold shadow hover:bg-[#5D3FD3] hover:text-white transition-colors" title="Bantuan">üìò</button>
                            <button onClick={handleShowDebug} className="w-8 h-8 rounded-full bg-white flex items-center justify-center text-[#4B0082] text-lg font-bold shadow hover:bg-[#5D3FD3] hover:text-white transition-colors" title="Debug">üêû</button>
                        </div>
                        <h1 className="text-3xl font-bold text-center mb-4 text-gray-800">üìä Tabel Skor</h1>
                        {notification.message && (
                            <div className={`p-3 rounded-lg mb-4 text-center text-sm ${notificationColors[notification.type]}`}>
                                <p>{notification.message}</p>
                            </div>
                        )}
                        <ScoreTable data={data} players={players} />
                        <WinSection 
                            players={players} 
                            onUpdateScore={handleUpdateScore} 
                            onUpdateTeamScore={handleUpdateTeamScore}
                            setNotification={setNotification}
                        />
                        <JokerTransferSection players={players} onJokerTransfer={handleJokerTransfer} />
                        <ActionsSection 
                            onUndo={handleUndo} 
                            onRedo={handleRedo} 
                            onResetScores={handleResetScores} 
                            onResetStakes={handleResetStakes}
                        />
                    </div>

                    <EditStakesModal 
                        isVisible={editStakesModalVisible}
                        onClose={() => setEditStakesModalVisible(false)}
                        data={data}
                        players={players}
                        onSave={handleSaveStakes}
                    />

                    <div className="fixed bottom-0 left-0 right-0 h-16 bg-[#4B0082] flex justify-around items-center shadow-lg z-50">
                        <button onClick={() => setEditModalVisible(true)} className="w-12 h-12 rounded-full bg-white flex items-center justify-center text-[#4B0082] text-xl font-bold shadow hover:bg-[#5D3FD3] hover:text-white transition-colors" title="Edit Skor">‚úèÔ∏è</button>
                        <button onClick={() => setEditPlayersModalVisible(true)} className="w-12 h-12 rounded-full bg-white flex items-center justify-center text-[#4B0082] text-xl font-bold shadow hover:bg-[#5D3FD3] hover:text-white transition-colors" title="Edit Pemain">üë•</button>
                        <button onClick={() => setEditStakesModalVisible(true)} className="w-12 h-12 rounded-full bg-white flex items-center justify-center text-[#4B0082] text-xl font-bold shadow hover:bg-gray-700 hover:text-white transition-colors" title="Edit Patokan">‚öôÔ∏è</button>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
